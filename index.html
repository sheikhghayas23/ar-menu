<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Spatial Pro AR - Fixed Overlap</title>

<style>
  :root { --accent: #00ffcc; --glass: rgba(0,0,0,0.8); }
  body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background: #000; }
  
  video { position: fixed; inset: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; }

  /* 3D Stage */
  #viewport {
    position: fixed; inset: 0; z-index: 2;
    perspective: 1500px; /* High perspective for depth */
    pointer-events: none;
  }

  #world {
    position: absolute; width: 100%; height: 100%;
    transform-style: preserve-3d;
    will-change: transform;
  }

  /* Food Anchor */
  .food-node {
    position: absolute;
    left: 50%; top: 50%;
    transform-style: preserve-3d;
    display: flex; flex-direction: column; align-items: center;
  }

  .dish {
    width: 250px;
    filter: drop-shadow(0 25px 40px rgba(0,0,0,0.8));
    animation: spawn 0.6s cubic-bezier(0.17, 0.88, 0.32, 1.2);
    border-radius: 50%;
  }

  /* Shadow to give ground feeling */
  .shadow {
    width: 200px; height: 50px;
    background: radial-gradient(ellipse at center, rgba(0,0,0,0.5) 0%, transparent 75%);
    transform: rotateX(90deg) translateZ(-30px);
    margin-top: -30px;
  }

  @keyframes spawn {
    0% { transform: translateZ(-500px) scale(0); opacity: 0; }
    100% { transform: translateZ(0) scale(1); opacity: 1; }
  }

  /* iPhone Style Reticle */
  #reticle {
    position: fixed; left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    width: 32px; height: 32px;
    border: 2px solid white; border-radius: 50%;
    z-index: 5; pointer-events: none;
  }
  #reticle::after { content: ''; position: absolute; inset: 12px; background: white; border-radius: 50%; }

  /* UI */
  #ui {
    position: fixed; bottom: 0; width: 100%;
    background: linear-gradient(to top, black 80%, transparent);
    z-index: 10; padding: 20px 0 50px;
  }

  .carousel { display: flex; gap: 12px; overflow-x: auto; padding: 0 20px; scrollbar-width: none; }
  .carousel::-webkit-scrollbar { display: none; }

  .card {
    min-width: 90px; padding: 15px;
    background: var(--glass); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 15px; color: white; text-align: center;
    transition: 0.2s;
  }
  .card.active { border-color: var(--accent); background: var(--accent); color: black; }
</style>
</head>
<body>

<video id="camera" autoplay playsinline></video>
<div id="reticle"></div>

<div id="viewport">
  <div id="world"></div>
</div>

<div id="ui">
  <div class="carousel" id="menu"></div>
  <div style="color:white; text-align:center; font-size:12px; margin-top:15px; opacity:0.6;">
    POINT AND TAP TO PLACE (DISHES WILL NOT OVERLAP)
  </div>
</div>

<script>
const foods = [
  { name: 'Biryani', img: 'https://media.istockphoto.com/id/501150349/photo/chicken-biryani-11.jpg?s=612x612&w=0&k=20&c=w6mDnUx8MnH3rnP9bR0VfWRwrODcbTz-6U07o3Zrs4o=' },
  { name: 'Pizza', img: 'https://img.freepik.com/free-psd/delicious-pepperoni-pizza-culinary-delight_632498-24206.jpg?w=740' },
  { name: 'Tacos', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTD-CUOhD5WqTgJIVDIjg40XOWKg4cf0rc56w&s' },
  { name: 'Burger', img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?q=80&w=500' }
];

let selected = foods[0];
const world = document.getElementById('world');
let gyro = { a: 0, b: 0 };
let placedAngles = []; // Store angles to prevent overlap

// Camera
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
  .then(s => document.getElementById('camera').srcObject = s);

// UI Menu
const menu = document.getElementById('menu');
foods.forEach((f, i) => {
  const c = document.createElement('div');
  c.className = `card ${i===0?'active':''}`;
  c.innerHTML = `<div>${f.name}</div>`;
  c.onclick = (e) => {
    e.stopPropagation();
    document.querySelectorAll('.card').forEach(x => x.classList.remove('active'));
    c.classList.add('active');
    selected = f;
  };
  menu.appendChild(c);
});

// Device Orientation (Tracking the Room)
window.addEventListener('deviceorientation', (e) => {
  gyro.a = e.alpha || 0; // Compass
  gyro.b = e.beta || 0;  // Tilt
  
  // Update the 3D world rotation
  world.style.transform = `rotateX(${gyro.b - 90}deg) rotateZ(${-gyro.a}deg)`;
});

// Place Logic
window.addEventListener('click', (e) => {
  if (e.target.closest('#ui')) return;

  // OVERLAP CHECK: If we already placed something within 15 degrees of this spot, nudge it
  let finalAlpha = gyro.a;
  let finalBeta = gyro.b;

  placedAngles.forEach(pos => {
    if (Math.abs(pos.a - finalAlpha) < 15 && Math.abs(pos.b - finalBeta) < 15) {
      finalAlpha += 20; // Nudge it to the side if it's too close
    }
  });

  placedAngles.push({a: finalAlpha, b: finalBeta});

  const node = document.createElement('div');
  node.className = 'food-node';

  // INCREASED DISTANCE: translateZ(900px) puts it further away in the room
  const distance = 900; 

  // Capture the spatial coordinates
  node.style.transform = `rotateZ(${finalAlpha}deg) rotateX(${-(finalBeta - 90)}deg) translateZ(${distance}px)`;

  const img = document.createElement('img');
  img.src = selected.img;
  img.className = 'dish';

  const shadow = document.createElement('div');
  shadow.className = 'shadow';

  node.appendChild(img);
  node.appendChild(shadow);
  world.appendChild(node);

  if(navigator.vibrate) navigator.vibrate(25);
});
</script>
</body>
</html>
