<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>AR Spatial Menu - Fixed Overlap</title>

<style>
  :root { --accent: #00ffcc; }
  body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background: #000; color: white; }
  
  video { position: fixed; inset: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; }

  /* 3D Container */
  #viewport { position: fixed; inset: 0; z-index: 2; perspective: 2000px; pointer-events: none; }
  #world { position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; }

  .spatial-node {
    position: absolute; left: 50%; top: 50%;
    transform-style: preserve-3d;
    display: flex; flex-direction: column; align-items: center;
  }

  .food-img {
    width: 250px; border-radius: 50%;
    filter: drop-shadow(0 20px 40px rgba(0,0,0,0.8));
    animation: dropIn 0.5s ease-out;
  }

  @keyframes dropIn {
    0% { transform: scale(0) translateZ(-500px); opacity: 0; }
    100% { transform: scale(1) translateZ(0); opacity: 1; }
  }

  /* Target Reticle */
  #reticle {
    position: fixed; left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    width: 35px; height: 35px;
    border: 2px solid white; border-radius: 50%;
    z-index: 5; pointer-events: none;
  }
  #reticle::after { content: ''; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; }

  /* UI Panel */
  #ui {
    position: fixed; bottom: 0; width: 100%;
    background: linear-gradient(to top, #000 80%, transparent);
    z-index: 10; padding: 20px 0 40px;
  }

  .carousel { display: flex; gap: 15px; overflow-x: auto; padding: 0 20px; scrollbar-width: none; }
  .carousel::-webkit-scrollbar { display: none; }

  .card {
    min-width: 100px; padding: 15px; background: rgba(255,255,255,0.1);
    border-radius: 18px; border: 1px solid rgba(255,255,255,0.2);
    text-align: center; font-weight: bold; transition: 0.3s;
  }
  .card.active { background: var(--accent); color: #000; border-color: #fff; }

  #reset-btn {
    position: fixed; top: 20px; right: 20px; z-index: 15;
    background: rgba(255,0,0,0.6); color: white; border: none;
    padding: 10px 15px; border-radius: 10px; font-weight: bold;
  }
</style>
</head>
<body>

<video id="camera" autoplay playsinline></video>
<button id="reset-btn" onclick="world.innerHTML = ''; placedNodes = [];">RESET</button>
<div id="reticle"></div>

<div id="viewport">
  <div id="world"></div>
</div>

<div id="ui">
  <div class="carousel" id="menu"></div>
</div>

<script>
const items = [
  { name: 'Biryani', img: 'https://media.istockphoto.com/id/501150349/photo/chicken-biryani-11.jpg?s=612x612&w=0&k=20&c=w6mDnUx8MnH3rnP9bR0VfWRwrODcbTz-6U07o3Zrs4o=' },
  { name: 'Pizza', img: 'https://img.freepik.com/free-psd/delicious-pepperoni-pizza-culinary-delight_632498-24206.jpg?w=740' },
  { name: 'Burger', img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?q=80&w=500' }
];

let selected = items[0];
let curA = 0, curB = 0;
let placedNodes = []; // Store coordinates to avoid overlap
const world = document.getElementById('world');

// Camera Setup
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
  .then(s => document.getElementById('camera').srcObject = s);

// Build Menu
const menuCont = document.getElementById('menu');
items.forEach((item, i) => {
  const c = document.createElement('div');
  c.className = `card ${i === 0 ? 'active' : ''}`;
  c.innerHTML = item.name;
  c.onclick = (e) => {
    e.stopPropagation();
    document.querySelectorAll('.card').forEach(x => x.classList.remove('active'));
    c.classList.add('active');
    selected = item;
  };
  menuCont.appendChild(c);
});

// Device Tracking
window.addEventListener('deviceorientation', (e) => {
  curA = e.alpha || 0;
  curB = e.beta || 0;
  world.style.transform = `rotateX(${curB - 90}deg) rotateZ(${-curA}deg)`;
});

// Click to Drop (with Collision Detection)
window.addEventListener('click', (e) => {
  if (e.target.closest('#ui') || e.target.id === 'reset-btn') return;

  let targetA = curA;
  let targetB = curB;
  let distance = 800;

  // OVERLAP FIX: Check if we are too close to a previous dish
  placedNodes.forEach(node => {
    const angleDiff = Math.abs(node.a - targetA);
    if (angleDiff < 15) { // If within 15 degrees
      targetA += 20; // Nudge it 20 degrees to the right
    }
  });

  placedNodes.push({a: targetA, b: targetB});

  const node = document.createElement('div');
  node.className = 'spatial-node';
  
  // Use the specific locked coordinates
  node.style.transform = `rotateZ(${targetA}deg) rotateX(${-(targetB - 90)}deg) translateZ(${distance}px)`;

  const img = document.createElement('img');
  img.src = selected.img;
  img.className = 'food-img';

  node.appendChild(img);
  world.appendChild(node);
  
  if(navigator.vibrate) navigator.vibrate(20);
});
</script>
</body>
</html>
