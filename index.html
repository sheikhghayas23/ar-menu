<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Smart AR Menu – REAL AR</title>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>

<style>
  body {
    margin: 0;
    overflow: hidden;
    background: black;
    font-family: system-ui;
  }

  #startAR {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 14px 22px;
    background: #00ffcc;
    color: black;
    border: none;
    border-radius: 14px;
    font-size: 18px;
    font-weight: 600;
    z-index: 10;
  }

  #message {
    position: fixed;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 6px 12px;
    border-radius: 10px;
    font-size: 14px;
    z-index: 10;
  }
</style>
</head>

<body>

<button id="startAR">Start AR</button>
<div id="message">Ready</div>

<script>
const message = document.getElementById("message");
function log(msg) { message.textContent = msg; }

/* FOOD IMAGES */
const pizza = "https://i.imgur.com/2yaf2wb.png";

/* THREE SETUP */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera();
const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
scene.add(light);

/* RETICLE */
const retGeo = new THREE.RingGeometry(0.06, 0.08, 32);
const retMat = new THREE.MeshBasicMaterial({ color: 0x00ffcc });
const reticle = new THREE.Mesh(retGeo, retMat);
reticle.rotation.x = -Math.PI / 2;
reticle.matrixAutoUpdate = false;
reticle.visible = false;
scene.add(reticle);

let xrSession = null;
let xrRefSpace = null;
let hitTestSource = null;

/* START AR SESSION */
async function startAR() {
  if (!navigator.xr) {
    log("WebXR not supported");
    return;
  }

  const supported = await navigator.xr.isSessionSupported("immersive-ar");
  if (!supported) {
    log("immersive-ar not supported on this device");
    return;
  }

  xrSession = await navigator.xr.requestSession("immersive-ar", {
    requiredFeatures: ["hit-test", "anchors"]
  });

  renderer.xr.setSession(xrSession);
  document.getElementById("startAR").style.display = "none";

  xrRefSpace = await xrSession.requestReferenceSpace("local");
  const viewerSpace = await xrSession.requestReferenceSpace("viewer");

  hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

  xrSession.addEventListener("select", placeFood);

  renderer.setAnimationLoop(onXRFrame);
}

/* PLACE FOOD */
async function placeFood(event) {
  if (!reticle.visible) return;

  const frame = event.frame;
  const hitResults = frame.getHitTestResults(hitTestSource);
  if (!hitResults.length) return;

  const hit = hitResults[0];
  const anchor = await hit.createAnchor();
  const anchorSpace = anchor.anchorSpace;

  const tex = new THREE.TextureLoader().load(pizza);
  const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true });
  const geo = new THREE.PlaneGeometry(0.3, 0.3);
  const mesh = new THREE.Mesh(geo, mat);
  mesh.rotation.x = -Math.PI / 2;

  const group = new THREE.Group();
  group.matrixAutoUpdate = false;
  group.add(mesh);
  scene.add(group);

  xrSession.addEventListener("frame", (ev) => {
    const pose = ev.frame.getPose(anchorSpace, xrRefSpace);
    if (pose) {
      group.matrix.fromArray(pose.transform.matrix);
    }
  });
}

/* FRAME LOOP */
function onXRFrame(time, frame) {
  if (!frame) return;

  const pose = frame.getViewerPose(xrRefSpace);
  if (!pose) return;

  const hits = frame.getHitTestResults(hitTestSource);
  if (hits.length) {
    const hit = hits[0];
    const hitPose = hit.getPose(xrRefSpace);
    reticle.visible = true;
    reticle.matrix.fromArray(hitPose.transform.matrix);
    log("Surface found — tap to place");
  } else {
    reticle.visible = false;
    log("Move phone to find a surface");
  }

  renderer.render(scene, camera);
}

document.getElementById("startAR").addEventListener("click", startAR);
</script>

</body>
</html>
